<!DOCTYPE html>
<html>
  <head>
    <script type="module">
      const SQUARE_SIZE = 50;
      const MS_BETWEEN_RENDERS = 2_000;
      const [CELL_WIDTH, CELL_HEIGHT] = [6, 12];
      const [CANVAS_WIDTH, CANVAS_HEIGHT] = [
        CELL_WIDTH * SQUARE_SIZE,
        CELL_HEIGHT * SQUARE_SIZE,
      ];
      const STARTER_ROWS = 4;

      class Game {
        #grid;
        #playing;
        #ctx;
        #intervalId = null;

        constructor() {
          this.#playing = false;
          let canvas = document.getElementById("canvas");
          canvas.width = CANVAS_WIDTH;
          canvas.height = CANVAS_HEIGHT;
          this.#ctx = canvas.getContext("2d");
        }

        resetGrid() {
          this.#grid = Array(CELL_HEIGHT).fill(Array(CELL_WIDTH).fill());
          for (let i = 0; i < STARTER_ROWS; i++) {
            this.appendRow();
          }
        }

        get isGameOver() {
          return !this.#grid[0].every((x) => x === undefined);
        }

        start() {
          if (this.#playing) {
            return; // can't start a running game
          }

          // start
          this.#playing = true;
          this.resetGrid();
          this.drawGrid();

          // game loop
          this.#intervalId = setInterval(() => {
            if (this.isGameOver) {
              this.stop();
              this.renderGameOver();
            } else {
              this.appendRow();
              this.drawGrid();
            }
          }, MS_BETWEEN_RENDERS);
        }

        stop() {
          this.#playing = false;
          clearInterval(this.#intervalId);
          this.clearCanvas();
        }

        renderGameOver() {
          this.#ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
          this.#ctx.fillStyle = "red";
          this.#ctx.font = "48px Arial";
          this.#ctx.textAlign = "center";
          this.#ctx.textBaseline = "middle";
          this.#ctx.fillText("Game Over", CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);
        }

        appendRow() {
          // shed top row
          this.#grid.shift();

          // add row to bottom
          this.#grid.push(Array(CELL_WIDTH).fill("r"));
        }

        clearCanvas() {
          this.#ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        drawGrid() {
          this.clearCanvas();
          for (var y = 0; y < this.#grid.length; y++) {
            for (var x = 0; x < this.#grid[y].length; x++) {
              this.drawSquare(
                x * SQUARE_SIZE,
                y * SQUARE_SIZE,
                this.#grid[y][x],
              );
            }
          }
        }

        drawSquare(x, y, c) {
          this.#ctx.beginPath();
          this.#ctx.moveTo(x, y);
          this.#ctx.lineTo(x + SQUARE_SIZE, y);
          this.#ctx.lineTo(x + SQUARE_SIZE, y + SQUARE_SIZE);
          this.#ctx.lineTo(x, y + SQUARE_SIZE);
          this.#ctx.lineTo(x, y);
          this.#ctx.stroke();
          this.#ctx.closePath();
          if (c) {
            this.#ctx.fillStyle = "black";
            this.#ctx.font = "24px Arial";
            this.#ctx.textAlign = "center";
            this.#ctx.textBaseline = "middle";
            this.#ctx.fillText(c, x + SQUARE_SIZE / 2, y + SQUARE_SIZE / 2);
          }
        }
      }

      const gs = new Game();
      gs.start();
    </script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
  </body>
</html>
